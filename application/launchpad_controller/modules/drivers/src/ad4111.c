/*
 * AD4111 Analog to Digital Converter (ADC) Driver
 *
 * Author: Love Mitteregger
 * Created: 10 jun 2024
 *
 */

// General libraries
#include <math.h>
#include <errno.h>
#include <string.h>
#include <stdlib.h>
#include <stdio.h>

// Zephyr libraries
#include <zephyr/kernel.h>
#include <zephyr/logging/log.h>
#include <zephyr/device.h>
#include <zephyr/drivers/spi.h>
#include <zephyr/drivers/gpio.h>
#include <zephyr/linker/devicetree_regions.h>
// #include <zephyr/ztest.h> // Zephyrs Testing Framework, must also be enabled in prj.conf if used

// AESIR libraries
#include "../inc/ad4111.h"
// Placeholder

// Set logging system to capture any log messages generated by the code
LOG_MODULE_REGISTER(ad4111, CONFIG_SENSOR_LOG_LEVEL);

/* REMEMBER: DRIVER FUNCTIONS SHOULD BE DESIGNED TO OPERATE INDEPENDENTLY OF THE NUMBER OF DEVICES USING THEM. */

struct adc_config{
    DEVICE_MMIO_ROM;
    adc_config_irq_t config_irq;
};

void ad4111_isr(const struct device *dev) {
    /* Handle interrupt */
}

int ad4111_init(const struct device *dev) {
    const struct adc_config *config = dev->config;
    /* Do other initialization stuff */
    config->config_irq(dev);
    
    return 0;
}

// Function for resetting the ADCs
// Returning CS' high sets the digital interface to the default state and halts any serial interface operation.

// Struct utilizing the adc subsystem api 
static struct adc_api ad4111_api_functions {
    .init = ad4111_init,                     // Initialize ADC
    .reset = ad4111_reset,                   // Reset ADC
    .config_channel = ad4111_config_channel, // Enable/Disable ADC channel
    .write_register = ad4111_write_register, // Write to ADC register
    .read_register = ad4111_read_register,   // Read from ADC register
    .read_data = ad4111_read_data,           // Read from ADC data register
    .handle_isr = ad4111_handle_isr          // Handle ADC interrupt service routine
};

// Define the configuration functions and structures for each instance
#if CONFIG_AD4111_0
DEVICE_DECLARE(ad4111_0);

static void ad4111_config_irq_0(const struct device *dev) {
    IRQ_CONNECT(DT_IRQN(DT_INST(0, ad4111)), DT_IRQ(DT_INST(0, ad4111), priority), ad4111_isr, DEVICE_GET(ad4111_0), 0);
}

static void ad4111_config_irq_0(const struct device *dev)
{
      IRQ_CONNECT(AD4111_0_IRQ, AD4111_0_PRI, ad4111_isr,
                  DEVICE_GET(ad4111_0), 0);
}

const static struct adc_config ad4111_config_0 = {
    DEVICE_MMIO_ROM_INIT(DT_DRV_INST(0)),
    .config_irq = ad4111_config_irq_0
};

static struct ad4111_data ad4111_data_0;

DEVICE_DEFINE(ad4111_0, DT_LABEL(DT_INST(0, ad4111)), ad4111_init, NULL, &ad4111_data_0, &ad4111_config_0, POST_KERNEL, CONFIG_KERNEL_INIT_PRIORITY_DEVICE, &ad4111_api_functions);
#endif

#if CONFIG_AD4111_1
DEVICE_DECLARE(ad4111_1);

static void ad4111_config_irq_1(const struct device *dev) {
    IRQ_CONNECT(DT_IRQN(DT_INST(1, ad4111)), DT_IRQ(DT_INST(1, ad4111), priority), ad4111_isr, DEVICE_GET(ad4111_1), 0);
}

const static struct adc_config ad4111_config_1 = {
    DEVICE_MMIO_ROM_INIT(DT_DRV_INST(1)),
    .config_irq = ad4111_config_irq_1
};

static struct ad4111_data ad4111_data_1;

DEVICE_DEFINE(ad4111_1, DT_LABEL(DT_INST(1, ad4111)), ad4111_init, NULL, &ad4111_data_1, &ad4111_config_1, POST_KERNEL, CONFIG_KERNEL_INIT_PRIORITY_DEVICE, &ad4111_api_functions);
#endif

// A macro to easily define and initialize an instance of the ADC driver.
#define ADC_DEVICE(inst)                                                   \
    static struct adc_data adc_data_##inst;                                \
    static const struct adc_config adc_config_##inst = {                   \
        .spi = SPI_DT_SPEC_INST_GET(inst),                                 \
        .config_irq = ad4111_config_irq_##inst,                            \
    };                                                                     \
    DEVICE_DT_INST_DEFINE(inst,                                            \
                          adc_init,                                        \
                          NULL,                                            \
                          &ad4111_data_##inst,                             \
                          &ad4111_config_##inst,                           \
                          POST_KERNEL,                                     \
                          CONFIG_KERNEL_INIT_PRIORITY_DEVICE,              \
                          &adc_api);

DT_INST_FOREACH_STATUS_OKAY(ADC_DEVICE);